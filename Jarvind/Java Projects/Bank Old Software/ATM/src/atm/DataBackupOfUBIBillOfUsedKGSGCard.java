/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * DataBackupOfUBIBillOfUsedKGSGCard.java
 *
 * Created on May 2, 2013, 5:35:52 PM
 */

package atm;

/**
 *
 * @author DEEP PAL
 */
public class DataBackupOfUBIBillOfUsedKGSGCard extends javax.swing.JInternalFrame {
javax.swing.JFileChooser jfc;
    /** Creates new form DataBackupOfUBIBillOfUsedKGSGCard */
    public DataBackupOfUBIBillOfUsedKGSGCard() {
        initComponents();
        jLabel2.setVisible(false);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jButton1 = new javax.swing.JButton();
        jButton4 = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();

        setBackground(new java.awt.Color(159, 208, 224));
        setClosable(true);
        setIconifiable(true);
        setTitle("Data Backup Of UBI Card Used In KGSG ATM");

        jPanel1.setBackground(new java.awt.Color(250, 245, 216));
        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        jPanel1.setLayout(null);

        jPanel2.setBackground(new java.awt.Color(254, 254, 237));
        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        jPanel2.setLayout(null);

        jLabel1.setFont(new java.awt.Font("Verdana", 1, 16));
        jLabel1.setForeground(new java.awt.Color(204, 102, 0));
        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel1.setText("Select UBI File ( UBI_4000 )");
        jPanel2.add(jLabel1);
        jLabel1.setBounds(160, 40, 360, 30);

        jButton1.setFont(new java.awt.Font("Verdana", 1, 16));
        jButton1.setForeground(new java.awt.Color(255, 102, 0));
        jButton1.setMnemonic('f');
        jButton1.setText("Select File");
        jButton1.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        jButton1.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jButton1KeyPressed(evt);
            }
        });
        jPanel2.add(jButton1);
        jButton1.setBounds(50, 160, 310, 35);

        jButton4.setFont(new java.awt.Font("Verdana", 1, 16));
        jButton4.setForeground(new java.awt.Color(255, 102, 0));
        jButton4.setMnemonic('x');
        jButton4.setText("Close (x)");
        jButton4.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jButton4.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton4ActionPerformed(evt);
            }
        });
        jPanel2.add(jButton4);
        jButton4.setBounds(380, 160, 290, 35);

        jLabel2.setBackground(new java.awt.Color(245, 245, 244));
        jLabel2.setIcon(new javax.swing.ImageIcon(getClass().getResource("/atm/PleaseWait.gif"))); // NOI18N
        jLabel2.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        jLabel2.setOpaque(true);
        jPanel2.add(jLabel2);
        jLabel2.setBounds(70, 10, 580, 220);

        jPanel1.add(jPanel2);
        jPanel2.setBounds(30, 30, 720, 240);

        getContentPane().add(jPanel1, java.awt.BorderLayout.CENTER);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:
        jfc=new javax.swing.JFileChooser();
        jfc.showOpenDialog(this);
        //System.out.println(jfc.getSelectedFile().getAbsoluteFile());
        class task1 extends Thread
        {
            public void run()
            {

                        try
                        {
                            jLabel1.setVisible(false);
                            jButton1.setVisible(false);
                            jButton4.setVisible(false);
                            jLabel2.setVisible(true);
                            readfile(jfc.getSelectedFile().getAbsoluteFile().toString());
                            Thread.sleep(100);
                        }
                        catch(InterruptedException ex)
                        {
                            System.out.println("error..."+ex);
                        }

            }

        }
                task1 t1=new task1();
                t1.start();
}//GEN-LAST:event_jButton1ActionPerformed

    private void jButton4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton4ActionPerformed
        // TODO add your handling code here:
        this.dispose();
    }//GEN-LAST:event_jButton4ActionPerformed

    private void jButton1KeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jButton1KeyPressed
        // TODO add your handling code here:
        if(evt.getKeyCode()==10)
        {
            jfc=new javax.swing.JFileChooser();
        jfc.showOpenDialog(this);
        //System.out.println(jfc.getSelectedFile().getAbsoluteFile());
        class task1 extends Thread
        {
            public void run()
            {

                        try
                        {
                            jLabel1.setVisible(false);
                            jButton1.setVisible(false);
                            jButton4.setVisible(false);
                            jLabel2.setVisible(true);
                            readfile(jfc.getSelectedFile().getAbsoluteFile().toString());
                            Thread.sleep(100);
                        }
                        catch(InterruptedException ex)
                        {
                            System.out.println("error..."+ex);
                        }

            }

        }
                task1 t1=new task1();
                t1.start();
        }
    }//GEN-LAST:event_jButton1KeyPressed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton4;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    // End of variables declaration//GEN-END:variables

    private boolean readfile(String filename)
    {
        try
        {
            jButton1.setEnabled(false);
            //connect with server
            //-----------------------
            interfaceATM object1=null;
            try
            {
		object1=(interfaceATM)java.rmi.Naming.lookup(getIPaddress.IP());
            }
            catch(Exception e)
            {
		System.out.println("Error at the time of connection with server "+getIPaddress.IP()+"..."+e);
                getIPaddress.changeIP();
		try
		{
			object1=(interfaceATM)java.rmi.Naming.lookup(getIPaddress.IP());
		}
		catch(Exception ex)
		{
			System.out.println("Error at the time of connection with server ip-rmi//127.0.0.1/railwayMethods  ..."+ex);
		}
            }
            //First find last record
            //----------------------
            String query="select tran_date from ubi_bill_of_kgsg_cards order by entry_no desc";
            //System.out.println(query);
            String last_tran_date=object1.getSingleValue(query);
            query="select tran_id from ubi_bill_of_kgsg_cards order by entry_no desc";
            String last_tran_id=object1.getSingleValue(query);
            //System.out.println("last dt="+last_tran_date);
            //System.out.println("last id="+last_tran_id);
            String check_string="";
            int position=-1;
            if(last_tran_id.equals("")==false && last_tran_date.equals("")==false)
            {
                last_tran_date=last_tran_date.substring(8,10)+"-"+last_tran_date.substring(5,7)+"-"+last_tran_date.substring(0,4);
                check_string =" "+last_tran_date+" "+last_tran_id;
                //System.out.println("checkstring ="+check_string);
                //position=find(filename, check_string);
                //System.out.println("position find="+position);
            }

            String wholedata="";
            String line=null;
            String dashline=" ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------";
            String blankline="";
            boolean flag=false;
            int countline=0;
            String trandate="",tranid="";

            java.io.RandomAccessFile raf=new java.io.RandomAccessFile(filename, "r");

            if(position>=0)
                if(raf!=null)
                    raf.seek(position);

            //System.out.println("position:"+position);
            while(raf.length()>raf.getFilePointer())
            {
                line=raf.readLine();
                //System.out.println("f:"+line);
                if(line.indexOf(" Date")==0)
                {
                    line=raf.readLine();
                    if(line.equals(dashline))
                    {
                         System.out.println("line.equals(dashline)");
                         line=raf.readLine();
                         flag=true;
                    }
                }


                if (line.equals(blankline))
                {
                    System.out.println("line.equals(blankline)");
                    line=raf.readLine();
                    if(line.equals(dashline))
                        flag=false;
                }

                if (flag==true && line.length()!=0)
                {
                    
                    if(line.substring(0,10).trim().length()!=0)
                    {
                        //System.out.println("flag    line.substring(0,10).trim().length()!=0........"+line.substring(0,10).trim().length());
                        wholedata=wholedata+line+"\n";
                        System.out.println(line);
                        countline++;
                    }
                }
            }
            System.out.println("total line read="+countline);
            //System.out.println("position find="+position);
            //if(last_tran_id.equals("")==false && last_tran_date.equals("")==false)
            if(position>=0)
            {
                //last_tran_date=last_tran_date.substring(8,10)+"-"+last_tran_date.substring(5,7)+"-"+last_tran_date.substring(0,4);
                //String check_string =" "+last_tran_date+"   "+last_tran_id;
                //System.out.println("check_string="+check_string);
                //System.out.println(wholedata.indexOf(check_string));
                if(wholedata.indexOf(check_string)>=0)
                {
                    //System.out.println("");
                    wholedata=wholedata.substring(wholedata.indexOf(check_string),wholedata.length());
                    wholedata=wholedata.substring(wholedata.indexOf("\n")+1,wholedata.length());
                    //System.out.println("data="+wholedata);
                }
            }
            System.out.println("data="+wholedata);
            System.out.println("data length="+wholedata.length());
            boolean response=object1.updateUBIBillOfKGSGCards(wholedata);
            System.out.println("response..."+response);
            if(response==true)
            {
                javax.swing.JOptionPane.showMessageDialog(this, "Congratulation! Information updated successfully.","Information",javax.swing.JOptionPane.INFORMATION_MESSAGE);
                jButton1.setEnabled(true);
                jButton1.setEnabled(true);
                jLabel1.setVisible(true);
                jButton1.setVisible(true);
                jButton4.setVisible(true);
                jLabel2.setVisible(false);
            }
            else
            {
                javax.swing.JOptionPane.showMessageDialog(this, "Sorry! Updation process terminated due to any reason.\nSo try again please.","Error Information",javax.swing.JOptionPane.ERROR_MESSAGE);
                jButton1.setEnabled(true);
                jButton1.setEnabled(true);
                jLabel1.setVisible(true);
                jButton1.setVisible(true);
                jButton4.setVisible(true);
                jLabel2.setVisible(false);
            }

        }
        catch(Exception ex)
        {
            System.out.println("error no. Ubi..."+ex);
            jButton1.setEnabled(true);
                jLabel1.setVisible(true);
                jButton1.setVisible(true);
                jButton4.setVisible(true);
                jLabel2.setVisible(false);
        }
        return true;
    }

    public int find(String f, String searchString) {
        int result1 = -1;
        int pos=-1;
        int c=0;
        String str="";
        java.util.Scanner in = null;
        try {
            in = new java.util.Scanner(new java.io.FileReader(f));
            while(in.hasNextLine() && result1<0)//&& !result)
            {
                System.out.println("c = "+c);
                str=in.nextLine();
                result1 = str.indexOf(searchString);
                System.out.println("c= "+c+" result = "+result1);
                System.out.println(pos+"str.length() = "+str.length());
                //result = in.nextLine().indexOf(searchString) >= 0;
                if(result1<0)
                {
                    pos=pos+str.length();
                }
                System.out.println("c= "+c+"   "+pos+"str.length() = "+str.length()+"   result = "+result1);
                c++;
            }
             System.out.println("c= "+c+"  result             =          "+result1);
            if(result1>=0)
                result1=pos;
        }
        catch(java.io.IOException e) {
            e.printStackTrace();
        }
        finally {
            try { in.close() ; } catch(Exception e) { /* ignore */ }
        }
        return result1;
    }
    
}
