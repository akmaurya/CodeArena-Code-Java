/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * DataBackupOfKGSGUsedInUBIAtm.java
 *
 * Created on May 1, 2013, 11:22:42 AM
 */

package atm;

/**
 *
 * @author DEEP PAL
 */
public class DataBackupOfKGSGUsedInUBIAtm extends javax.swing.JInternalFrame {
javax.swing.JFileChooser jfc;
    /** Creates new form DataBackupOfKGSGUsedInUBIAtm */
    public DataBackupOfKGSGUsedInUBIAtm() {
        initComponents();
        jLabel2.setVisible(false);
        jButton3.setVisible(false);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        jButton3 = new javax.swing.JButton();

        setBackground(new java.awt.Color(159, 208, 224));
        setClosable(true);
        setIconifiable(true);
        setTitle("Data Backup Of KGSG Card Used In UBI ATM");

        jPanel1.setBackground(new java.awt.Color(250, 245, 216));
        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        jPanel1.setLayout(null);

        jPanel2.setBackground(new java.awt.Color(254, 254, 237));
        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        jPanel2.setLayout(null);

        jLabel1.setFont(new java.awt.Font("Verdana", 1, 16));
        jLabel1.setForeground(new java.awt.Color(204, 102, 0));
        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel1.setText("Select KGSG File ( KGSG_4900 )");
        jPanel2.add(jLabel1);
        jLabel1.setBounds(140, 40, 310, 20);

        jButton1.setFont(new java.awt.Font("Verdana", 1, 16));
        jButton1.setForeground(new java.awt.Color(255, 102, 0));
        jButton1.setMnemonic('f');
        jButton1.setText("Select File");
        jButton1.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        jButton1.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jButton1KeyPressed(evt);
            }
        });
        jPanel2.add(jButton1);
        jButton1.setBounds(30, 140, 270, 35);

        jButton2.setFont(new java.awt.Font("Verdana", 1, 16));
        jButton2.setForeground(new java.awt.Color(255, 102, 0));
        jButton2.setMnemonic('x');
        jButton2.setText("Close (x)");
        jButton2.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });
        jButton2.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jButton2KeyPressed(evt);
            }
        });
        jPanel2.add(jButton2);
        jButton2.setBounds(320, 140, 270, 35);

        jPanel1.add(jPanel2);
        jPanel2.setBounds(30, 30, 620, 220);

        jLabel2.setBackground(new java.awt.Color(245, 245, 244));
        jLabel2.setIcon(new javax.swing.ImageIcon(getClass().getResource("/atm/PleaseWait.gif"))); // NOI18N
        jLabel2.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        jLabel2.setOpaque(true);
        jPanel1.add(jLabel2);
        jLabel2.setBounds(55, 35, 570, 210);

        jButton3.setText("jButton3");
        jButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton3ActionPerformed(evt);
            }
        });
        jPanel1.add(jButton3);
        jButton3.setBounds(170, 180, 73, 23);

        getContentPane().add(jPanel1, java.awt.BorderLayout.CENTER);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:


        jfc=new javax.swing.JFileChooser();
        jfc.showOpenDialog(this);
       class task1 extends Thread
        {
            public void run()
            {
                try
                {
                    jLabel1.setVisible(false);
                    jButton1.setVisible(false);
                    jButton2.setVisible(false);
                    jLabel2.setVisible(true);

                     readfile(jfc.getSelectedFile().getAbsoluteFile().toString());
                     Thread.sleep(100);
                }
                catch(InterruptedException ex)
                {
                     System.out.println("error..."+ex);
                }
            }
        }
        task1 t1=new task1();
        t1.start();
        
        //System.out.println(jfc.getSelectedFile().getAbsoluteFile());
        

    }//GEN-LAST:event_jButton1ActionPerformed


    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        // TODO add your handling code here:
        this.dispose();
    }//GEN-LAST:event_jButton2ActionPerformed

    private void jButton2KeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jButton2KeyPressed
        // TODO add your handling code here:
        if(evt.getKeyCode()==10)
        {
            this.dispose();
        }
    }//GEN-LAST:event_jButton2KeyPressed

    private void jButton1KeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jButton1KeyPressed
        // TODO add your handling code here:
        if(evt.getKeyCode()==10)
        {
            jfc=new javax.swing.JFileChooser();
        jfc.showOpenDialog(this);
       class task1 extends Thread
        {
            public void run()
            {

                        try
                        {
                            jLabel1.setVisible(false);
                            jButton1.setVisible(false);
                            jButton2.setVisible(false);
                            jLabel2.setVisible(true);
                            readfile(jfc.getSelectedFile().getAbsoluteFile().toString());
                            Thread.sleep(100);
                        }
                        catch(InterruptedException ex)
                        {
                            System.out.println("error..."+ex);
                        }

            }

        }


                task1 t1=new task1();
                t1.start();
        }
    }//GEN-LAST:event_jButton1KeyPressed

    private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
        // TODO add your handling code here:
        del();
    }//GEN-LAST:event_jButton3ActionPerformed
    


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    // End of variables declaration//GEN-END:variables

    private boolean readfile(String filename)
    {
        try
        {
            jButton1.setEnabled(false);
            //connect with server
            //-----------------------
            interfaceATM object1=null;
            try
            {
		object1=(interfaceATM)java.rmi.Naming.lookup(getIPaddress.IP());
            }
            catch(Exception e)
            {
		System.out.println("Error at the time of connection with server "+getIPaddress.IP()+"..."+e);
                getIPaddress.changeIP();
		try
		{
			object1=(interfaceATM)java.rmi.Naming.lookup(getIPaddress.IP());
		}
		catch(Exception ex)
		{
			System.out.println("Error at the time of connection with server ip-rmi//127.0.0.1/railwayMethods  ..."+ex);
		}
            }
            String query="select tran_date from kgsg_n_ubi order by entry_no desc";
            String last_tran_date=object1.getSingleValue(query);
            query="select tran_id from kgsg_n_ubi order by entry_no desc";
            String last_tran_id=object1.getSingleValue(query);
            //System.out.println("last dt="+last_tran_date);
            //System.out.println("last id="+last_tran_id);
            String check_string="";
            int position=-1;
            if(last_tran_id.equals("")==false && last_tran_date.equals("")==false)
            {
                last_tran_date=last_tran_date.substring(8,10)+"-"+last_tran_date.substring(5,7)+"-"+last_tran_date.substring(0,4);
                check_string =" "+last_tran_date+"   "+last_tran_id;
                //position=find(filename, check_string);
                //System.out.println("position find="+position);
            }
            String wholedata="";
            String line=null;
            String dashline=" ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------";
            String blankline="";
            boolean flag=false;
            int countline=0;
            String trandate="",tranid="";

            java.io.RandomAccessFile raf=new java.io.RandomAccessFile(filename, "r");

            if(position>=0)
                if(raf!=null)
                    raf.seek(position);

            //System.out.println(raf.length());
            while(raf.length()>raf.getFilePointer())
            {
                line=raf.readLine();
                if(line.indexOf("  Date")==0)
                {
                    line=raf.readLine();
                    if(line.equals(dashline))
                    {
                        line=raf.readLine();
                        flag=true;
                    }
                }
                
                if (line.equals(blankline))
                {
                    line=raf.readLine();
                    if(line.equals(dashline))
                        flag=false;
                }
                
                if (flag)
                {

                    wholedata=wholedata+line+"\n";
                    System.out.println(line);
                    countline++;
                }
            }
            System.out.println("total line read="+countline);
            //if(last_tran_id.equals("")==false && last_tran_date.equals("")==false)
            if(position>=0)
            {
                //last_tran_date=last_tran_date.substring(8,10)+"-"+last_tran_date.substring(5,7)+"-"+last_tran_date.substring(0,4);
                //String check_string =" "+last_tran_date+"   "+last_tran_id;
                //System.out.println("check_string="+check_string);
                //System.out.println(wholedata.indexOf(check_string));
                if(wholedata.indexOf(check_string)>=0)
                {
                    //System.out.println("ok");
                    wholedata=wholedata.substring(wholedata.indexOf(check_string),wholedata.length());
                    wholedata=wholedata.substring(wholedata.indexOf("\n")+1,wholedata.length());
                    System.out.println("data="+wholedata);
                }
            }

            boolean response=object1.updateKGSGInUBI(wholedata);
            System.out.println("response..."+response);
            if(response==true)
            {
                javax.swing.JOptionPane.showMessageDialog(this, "Congratulation! Information updated successfully.","Information",javax.swing.JOptionPane.INFORMATION_MESSAGE);
                jButton1.setEnabled(true);
                jLabel1.setVisible(true);
                jButton1.setVisible(true);
                jButton2.setVisible(true);
                jLabel2.setVisible(false);
            }
            else
            {
                javax.swing.JOptionPane.showMessageDialog(this, "Sorry! Updation process terminated due to any reason.\nSo try again please.","Error Information",javax.swing.JOptionPane.ERROR_MESSAGE);
                jButton1.setEnabled(true);
                jLabel1.setVisible(true);
                jButton1.setVisible(true);
                jButton2.setVisible(true);
                jLabel2.setVisible(false);
            }

        }
        catch(Exception ex)
        {
            System.out.println("error no. 1..."+ex);
            jButton1.setEnabled(true);
                jLabel1.setVisible(true);
                jButton1.setVisible(true);
                jButton2.setVisible(true);
                jLabel2.setVisible(false);
        }
        return true;
    }

    public int find(String f, String searchString) {
        int result1 = -1;
        int pos=-1;
        String str="";
        int c=1;
        java.util.Scanner in = null;
        try {
            in = new java.util.Scanner(new java.io.FileReader(f));
            while(in.hasNextLine() && result1<0)//&& !result)
            {
                System.out.println("c = "+c);
                str=in.nextLine();
                result1 = str.indexOf(searchString);
                System.out.println("c= "+c+" result = "+result1);
                System.out.println(pos+"str.length() = "+str.length()+"   result = "+result1);
                if(result1<0)
                {
                    pos=pos+str.length();
                }
                System.out.println("c= "+c+" pos= "+pos+" result = "+result1);
                c++;
            }
            System.out.println("result             =          "+result1);
            if(result1>=0)
                result1=pos;
        }
        catch(java.io.IOException e) {
            e.printStackTrace();
        }
        finally {
            try { in.close() ; } catch(Exception e) { /* ignore */ }
        }
        return result1;
    }
    public void del()
    {
        try
        {
            //connect with server
            //-----------------------
            interfaceATM object1=null;
            try
            {
		object1=(interfaceATM)java.rmi.Naming.lookup(getIPaddress.IP());
            }
            catch(Exception e)
            {
		System.out.println("Error at the time of connection with server "+getIPaddress.IP()+"..."+e);
                getIPaddress.changeIP();
		try
		{
			object1=(interfaceATM)java.rmi.Naming.lookup(getIPaddress.IP());
		}
		catch(Exception ex)
		{
			System.out.println("Error at the time of connection with server ip-rmi//127.0.0.1/railwayMethods  ..."+ex);
		}
            }
            String query="delete  from ubi_bill_of_kgsg_cards ";
            System.out.println(query);
            object1.saveInformation(query);
            System.out.println("hello    ,,.....");
            }
        catch(Exception e) {
            e.printStackTrace();
        }
    }
}
